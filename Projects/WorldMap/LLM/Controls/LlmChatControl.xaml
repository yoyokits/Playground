<UserControl x:Class="LLM.Controls.LlmChatControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Loaded="UserControl_Loaded"
             Unloaded="UserControl_Unloaded"
             MinWidth="420"
             MinHeight="300">
    <UserControl.Resources>
        <!-- Message Template (User messages: reuse ↺, all: copy 📋) -->
        <DataTemplate x:Key="MessageTemplate">
            <Border Margin="0,3"
                    Padding="6"
                    CornerRadius="4"
                    BorderBrush="#444"
                    BorderThickness="1">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="#303030" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Role}" Value="System">
                                <Setter Property="Background" Value="#3C3C3C" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Role}" Value="User">
                                <Setter Property="Background" Value="#2D466E" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Role}" Value="Assistant">
                                <Setter Property="Background" Value="#465A2D" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Role -->
                    <TextBlock Grid.Row="0"
                               Grid.Column="0"
                               Text="{Binding Role}"
                               FontWeight="Bold"
                               Foreground="#DDD" />

                    <!-- Reuse (only for User) -->
                    <Button Grid.Row="0"
                            Grid.Column="1"
                            Width="24"
                            Height="20"
                            Margin="4,0,0,0"
                            Content="↺"
                            FontSize="12"
                            Tag="{Binding Content}"
                            ToolTip="Reuse this input"
                            Click="ReuseUserMessage_Click">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="BorderBrush" Value="#666" />
                                <Setter Property="Opacity" Value="0.65" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Role}" Value="User">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Opacity" Value="1" />
                                        <Setter Property="Background" Value="#55607A" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Copy -->
                    <Button Grid.Row="0"
                            Grid.Column="2"
                            Width="24"
                            Height="20"
                            Margin="4,0,0,0"
                            Content="📋"
                            FontSize="12"
                            Tag="{Binding Content}"
                            ToolTip="Copy message"
                            Click="CopyMessage_Click">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="BorderBrush" Value="#666" />
                                <Setter Property="Opacity" Value="0.6" />
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Opacity" Value="1.0" />
                                        <Setter Property="Background" Value="#555" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Content -->
                    <TextBlock Grid.Row="1"
                               Grid.Column="0"
                               Grid.ColumnSpan="3"
                               Margin="0,4,0,0"
                               Text="{Binding Content}"
                               TextWrapping="Wrap"
                               Foreground="#DDD" />
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!-- Top controls -->
            <RowDefinition Height="*" />
            <!-- Conversation -->
            <RowDefinition Height="Auto" />
            <!-- Input -->
            <RowDefinition Height="Auto" />
            <!-- Command bar -->
        </Grid.RowDefinitions>

        <!-- Top controls (3 rows now) -->
        <Grid Grid.Row="0" Margin="0,0,0,4">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Row 1: Provider selection -->
            <TextBlock Grid.Row="0" Grid.Column="0"
                       Text="Provider:"
                       VerticalAlignment="Center"
                       Margin="0,0,4,0"
                       Foreground="#DDD" />
            <ComboBox Grid.Row="0" Grid.Column="1"
                      x:Name="ProviderCombo"
                      SelectionChanged="ProviderCombo_SelectionChanged"
                      MinWidth="120"
                      Margin="0,0,6,0" />
            <Button Grid.Row="0" Grid.Column="3"
                    x:Name="SettingsButton"
                    Content="Settings"
                    Width="90"
                    Height="26"
                    Click="SettingsButton_Click"
                    Margin="0,0,6,0" />

            <!-- Row 2: Model selection -->
            <TextBlock Grid.Row="1" Grid.Column="0"
                       Text="Model:"
                       VerticalAlignment="Center"
                       Margin="0,4,4,0"
                       Foreground="#DDD" />
            <ComboBox Grid.Row="1" Grid.Column="1"
                      x:Name="ModelCombo"
                      ItemsSource="{Binding ModelNames}"
                      SelectionChanged="ModelCombo_SelectionChanged"
                      MinWidth="200"
                      Margin="0,4,6,0" />
            <Button Grid.Row="1" Grid.Column="2"
                    x:Name="RefreshButton"
                    Width="34"
                    Height="26"
                    Content="↻"
                    ToolTip="Refresh models"
                    Click="RefreshButton_Click"
                    Margin="0,4,6,0" />

            <!-- Row 3: Options -->
            <CheckBox Grid.Row="2" Grid.Column="0"
                      Grid.ColumnSpan="2"
                      x:Name="EnterSendsCheckBox"
                      Content="Enter sends (Ctrl+Enter newline)"
                      Checked="EnterSendsCheckBox_Changed"
                      Unchecked="EnterSendsCheckBox_Changed"
                      Foreground="#DDD"
                      Margin="0,4,0,0" />
            <TextBlock Grid.Row="2" Grid.Column="2"
                       Margin="12,6,0,0"
                       Foreground="#888"
                       Text="Reuse: ↺  Copy: 📋" />
        </Grid>

        <!-- Conversation -->
        <Border Grid.Row="1"
                BorderBrush="#444"
                BorderThickness="1"
                Background="#1E1E1E">
            <ScrollViewer x:Name="ConversationScroll"
                          VerticalScrollBarVisibility="Auto"
                          Padding="4">
                <ItemsControl x:Name="ConversationItems"
                              ItemTemplate="{StaticResource MessageTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Input (multiline) -->
        <Border Grid.Row="2"
                BorderBrush="#444"
                BorderThickness="1"
                Margin="0,4,0,4"
                Background="#252526">
            <TextBox x:Name="InputBox"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto"
                     MinHeight="80"
                     MaxHeight="240"
                     Background="Transparent"
                     Foreground="#DDD"
                     BorderThickness="0"
                     Padding="6"
                     FontFamily="Consolas"
                     FontSize="13"
                     PreviewKeyDown="InputBox_PreviewKeyDown"
                     ToolTip="Type message. Enter sends (if enabled). Ctrl+Enter newline." />
        </Border>

        <!-- Command bar -->
        <StackPanel Grid.Row="3"
                    Orientation="Horizontal">
            <Button x:Name="SendButton"
                    Width="80"
                    Height="28"
                    Margin="0,0,4,0"
                    Content="Send"
                    Click="SendButton_Click" />
            <Button x:Name="CancelButton"
                    Width="80"
                    Height="28"
                    Margin="0,0,4,0"
                    Content="Cancel"
                    IsEnabled="False"
                    Click="CancelButton_Click" />
            <Button x:Name="ClearButton"
                    Width="80"
                    Height="28"
                    Margin="0,0,10,0"
                    Content="Clear"
                    Click="ClearButton_Click" />
            <ProgressBar x:Name="Progress"
                         Width="120"
                         Height="6"
                         Margin="0,0,10,0"
                         IsIndeterminate="True"
                         Visibility="Collapsed"
                         VerticalAlignment="Center" />
            <TextBlock x:Name="StatusBlock"
                       VerticalAlignment="Center"
                       Foreground="#999"
                       Text="Ready" />
        </StackPanel>
    </Grid>
</UserControl>